name: ðŸ›¡ï¸ Python Critical Security Checks

on:
  push:
    branches: [master, develop, feature/**]
  pull_request:
    branches: [master, develop, release/**]

jobs:
  quality-checks:
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: ðŸ’¾ Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: âš™ï¸ Configure PYTHONPATH
        run: echo "PYTHONPATH=$(pwd)/src/app" >> $GITHUB_ENV

      - name: ðŸ“¦ Install core dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "âš ï¸ Arquivo requirements.txt nÃ£o encontrado, instalando dependÃªncias padrÃ£o..."
            pip install pytest ruff bandit safety coverage
          fi

      - name: ðŸ” Verify installations
        run: |
          echo "ðŸ“¦ **Pacotes instalados:**"
          python -m pip list | grep -E "pytest|ruff|bandit|safety|coverage"
          echo ""
          python -m pytest --version || echo "âŒ pytest nÃ£o instalado"
          ruff --version || echo "âŒ ruff nÃ£o instalado"
          bandit --version || echo "âŒ bandit nÃ£o instalado"
          safety --version || echo "âŒ safety nÃ£o instalado"
          coverage --version || echo "âŒ coverage nÃ£o instalado"

      - name: ðŸš¨ Run Critical Checks
        run: |
          echo "# ðŸ§ª RelatÃ³rio de Qualidade de CÃ³digo" > $GITHUB_STEP_SUMMARY
          echo "ðŸ“… ExecuÃ§Ã£o: $(TZ='America/Sao_Paulo' date +'%d/%m/%Y %H:%M:%S (BRT)')" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY

          RUFF_STATUS="âœ… Nenhum problema"
          BANDIT_STATUS="âœ… Nenhuma vulnerabilidade"
          SAFETY_STATUS="âœ… Sem CVEs crÃ­ticos"
          TESTS_STATUS="âœ… Todos passaram"

          echo "## ðŸ” Ruff (bugs e seguranÃ§a)" >> $GITHUB_STEP_SUMMARY
          ruff check src/ --select B,S --format=github > ruff_output.log || true
          if grep "::error" ruff_output.log > /dev/null; then
            RUFF_STATUS="âŒ Problemas encontrados"
            echo '| Arquivo | Linha | CÃ³digo | DescriÃ§Ã£o |' >> $GITHUB_STEP_SUMMARY
            echo '|---------|-------|--------|-----------|' >> $GITHUB_STEP_SUMMARY
            grep "::error" ruff_output.log | awk -F'::' '{split($3, loc, ":"); print "| " loc[1] " | " loc[2] " | " $4 " | " $5 " |"}' >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Nenhum problema crÃ­tico encontrado com Ruff." >> $GITHUB_STEP_SUMMARY
          fi

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ” Bandit (vulnerabilidades de cÃ³digo)" >> $GITHUB_STEP_SUMMARY
          bandit -r src/ -ll --severity-level high --confidence-level high -f custom \
            --msg-template "{abspath}:{line}: {severity}: {test_id}: {msg}" > bandit_output.log || true
          if [ -s bandit_output.log ]; then
            BANDIT_STATUS="âŒ Vulnerabilidades encontradas"
            echo '| Arquivo | Linha | Severidade | CÃ³digo | DescriÃ§Ã£o |' >> $GITHUB_STEP_SUMMARY
            echo '|---------|-------|------------|--------|-----------|' >> $GITHUB_STEP_SUMMARY
            awk -F':' '{print "| " $1 " | " $2 " | " $3 " | " $4 " | " $5 " |"}' bandit_output.log >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Nenhuma vulnerabilidade alta identificada com Bandit." >> $GITHUB_STEP_SUMMARY
          fi

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ Safety (vulnerabilidades em dependÃªncias)" >> $GITHUB_STEP_SUMMARY
          if [ -f requirements.txt ]; then
            safety check -r requirements.txt --output=bare > safety_output.log || true
          else
            safety check --output=bare > safety_output.log || true
          fi
          if grep -i "CRITICAL" safety_output.log > /dev/null; then
            SAFETY_STATUS="âŒ CVEs crÃ­ticos encontrados"
            echo '| Pacote | VersÃ£o | CVE | DescriÃ§Ã£o |' >> $GITHUB_STEP_SUMMARY
            echo '|--------|--------|-----|------------|' >> $GITHUB_STEP_SUMMARY
            grep -i "CRITICAL" safety_output.log | awk -F',' '{print "| " $1 " | " $2 " | " $3 " | " $5 " |"}' >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Nenhum CVE crÃ­tico encontrado com Safety." >> $GITHUB_STEP_SUMMARY
          fi

      - name: âœ… Run Tests with Coverage
        run: |
          if [ -d "src/tests" ]; then
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "## ðŸ§ª Resultados dos Testes UnitÃ¡rios" >> $GITHUB_STEP_SUMMARY

            coverage run -m pytest src/tests -v > result.log
            TEST_RESULT=$?

            if [ $TEST_RESULT -eq 0 ]; then
              echo "âœ… Todos os testes passaram com sucesso." >> $GITHUB_STEP_SUMMARY
            else
              TESTS_STATUS="âŒ Falhas encontradas nos testes"
              echo "âŒ Falhas encontradas:" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              grep -E "FAILURES|FAILED|ERROR" -A 10 result.log >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi

            echo "## ðŸ“ˆ Cobertura de Testes" >> $GITHUB_STEP_SUMMARY
            echo '| Arquivo | Cobertura |' >> $GITHUB_STEP_SUMMARY
            echo '|---------|-----------|' >> $GITHUB_STEP_SUMMARY
            coverage report --omit="*/tests/*,*/__init__.py" | tail -n +3 | grep -v "TOTAL" | awk '{printf("| `%s` | %s |\n", $1, $4)}' >> $GITHUB_STEP_SUMMARY
            TOTAL_COVERAGE=$(coverage report | grep TOTAL | awk '{print $4}')
            echo "**Cobertura Total:** $TOTAL_COVERAGE" >> $GITHUB_STEP_SUMMARY

            coverage html -d coverage_html
          else
            echo "âš ï¸ Pasta de testes nÃ£o encontrada (src/tests)."
            exit 0
          fi

      - name: â˜ï¸ Upload HTML Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage_html/
          retention-days: 7

      - name: ðŸ“Œ Resumo Final + Link para RelatÃ³rio HTML
        run: |
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Resumo Final" >> $GITHUB_STEP_SUMMARY
          echo '| VerificaÃ§Ã£o | Status |' >> $GITHUB_STEP_SUMMARY
          echo '|-------------|--------|' >> $GITHUB_STEP_SUMMARY
          echo "| Ruff         | $RUFF_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| Bandit       | $BANDIT_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| Safety       | $SAFETY_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| Testes       | $TESTS_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [Clique aqui para acessar o RelatÃ³rio de Cobertura HTML (Artifact)](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
