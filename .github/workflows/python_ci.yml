name: Python Critical Security Checks

on:
  push:
    branches: [master, develop, feature/**]
  pull_request:
    branches: [master, develop, release/**]

jobs:
  quality-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Configure PYTHONPATH
        run: echo "PYTHONPATH=$(pwd)/src/app" >> $GITHUB_ENV

      - name: Install core dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "âš ï¸ requirements.txt nÃ£o encontrado, instalando dependÃªncias bÃ¡sicas..."
            pip install pytest ruff bandit safety coverage
          fi

      - name: Verify installations
        run: |
          echo "ðŸ“œ **VersÃµes instaladas:**"
          python -m pip list | grep -E "pytest|ruff|bandit|safety|coverage"
          python -m pytest --version || echo "âŒ pytest nÃ£o instalado"
          ruff --version || echo "âŒ ruff nÃ£o instalado"
          bandit --version || echo "âŒ bandit nÃ£o instalado"
          safety --version || echo "âŒ safety nÃ£o instalado"
          coverage --version || echo "âŒ coverage nÃ£o instalado"

      - name: Run Critical Checks
        run: |
          echo "## ðŸ”´ **RelatÃ³rio de Qualidade**" > $GITHUB_STEP_SUMMARY
          echo "ðŸ“… **ExecuÃ§Ã£o:** $(TZ='America/Sao_Paulo' date +'%d/%m/%Y %H:%M:%S (BRT)')" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ” **Ruff (Bugs/Security)**" >> $GITHUB_STEP_SUMMARY
          ruff check src/ --select B,S --exit-non-zero-on-fix --format=github | grep "::error" | awk -F'::' '{print "| " $3 " | " $4 " | " $5 " |"}' >> $GITHUB_STEP_SUMMARY || echo "âœ… Nenhum problema crÃ­tico encontrado." >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ”’ **Bandit (Vulnerabilidades)**" >> $GITHUB_STEP_SUMMARY
          bandit -r src/ -ll --severity-level high --confidence-level high -f custom --msg-template "{abspath}:{line}: {severity}: {test_id}: {msg}" | awk -F':' '{print "| " $1 " | " $2 " | " $5 " |"}' >> $GITHUB_STEP_SUMMARY || echo "âœ… Nenhuma vulnerabilidade alta encontrada." >> $GITHUB_STEP_SUMMARY

          echo "### âš ï¸ **Safety (CVEs CrÃ­ticos)**" >> $GITHUB_STEP_SUMMARY
          safety check --output brief | grep -i "CRITICAL" >> $GITHUB_STEP_SUMMARY || echo "âœ… Nenhuma vulnerabilidade crÃ­tica em dependÃªncias." >> $GITHUB_STEP_SUMMARY

      - name: Run Tests with Coverage
        run: |
          if [ -d "src/tests" ]; then
            echo "### âœ… **Resultados dos Testes**" >> $GITHUB_STEP_SUMMARY
            pytest src/tests --maxfail=1 --disable-warnings --tb=short > result.log || echo "âŒ Um ou mais testes falharam!" >> $GITHUB_STEP_SUMMARY
            
            if grep -q "FAILED" result.log; then
              echo "âš ï¸ **Testes que falharam:**" >> $GITHUB_STEP_SUMMARY
              grep "FAILED" result.log | awk '{print "- **" $1 "**: " $0}' >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… Todos os testes passaram!" >> $GITHUB_STEP_SUMMARY
            fi

            echo "### ðŸ§ª **Cobertura de Testes**" >> $GITHUB_STEP_SUMMARY
            echo '| **Arquivo** | **Cobertura** |' >> $GITHUB_STEP_SUMMARY
            echo '|-------------|---------------|' >> $GITHUB_STEP_SUMMARY
            coverage report --omit="*/tests/*,*/__init__.py" | tail -n +3 | grep -v "TOTAL" | awk '{printf("| `%s` | %s |\n", $1, $4)}' >> $GITHUB_STEP_SUMMARY

            coverage html -d coverage_html
          else
            echo "âš ï¸ **Pasta de testes nÃ£o encontrada em src/tests.**"
            exit 0
          fi

      - name: Upload Coverage HTML Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage_html/
          retention-days: 7

      - name: Link para HTML no Step Summary
        run: |
          echo "ðŸ”— [**Abrir RelatÃ³rio de Cobertura HTML (via Artifact)**](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
